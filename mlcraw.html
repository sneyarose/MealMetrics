<!DOCTYPE html>
<html>
<head>
  <title>Multiple Linear Regression</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script>
    // Global variable to store the original data
    let originalData = [];
    let models = []; // Array to store 20 models, one for each food ID

    function processCSV(csv) {
      const rows = csv.split('\n');
      const data = [];

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i].trim(); // Trim whitespace from the row
        if (row !== "") { // Skip empty rows
          const columns = row.split(',');
          const foodId = parseInt(columns[0]);
          const orders = parseInt(columns[3]);
          const date = new Date(columns[4]);
          const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();
          const item = [foodId, orders, dayOfWeek];
          data.push(item);
        }
      }

      // Store the original data for later filtering
      originalData = data;

      return data;
    }

    async function handleFileSelect(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = async function (e) {
        const csv = e.target.result;
        const processedData = processCSV(csv);

        // Preprocess the training data (normalization)
        const normalizedTrainingData = processedData.map((data) => [
          data[0] / 5, // Food ID (Normalized)
          data[1] / 140, // Number of Orders (Normalized)
          data[2] / 7 // Day of the Week (Normalized)
        ]);

        // Convert the training data to TensorFlow tensors
        const trainingDataTensor = tf.tensor2d(normalizedTrainingData.map((data) => [data[0], data[2]])); // Use food ID and day of the week as input features
        const trainingLabelsTensor = tf.tensor2d(normalizedTrainingData.map((data) => [data[1]])); // Use number of orders as labels

        // Create the model
        const model = tf.sequential();
        model.add(tf.layers.dense({ units: 1, inputShape: [2] }));

        // Compile the model
        model.compile({ loss: 'meanSquaredError', optimizer: 'sgd' });

        // Train the model
        async function trainModel() {
          await model.fit(trainingDataTensor, trainingLabelsTensor, { epochs: 500 });
        }

        await trainModel(); // Await the completion of model training

        // Function to train the model for a specific food ID and store it in the models array
        async function trainModelForFoodId(foodId) {
          const filteredData = originalData.filter(item => item[0] === foodId);

          // Preprocess the filtered training data (normalization)
          const normalizedFilteredData = filteredData.map((data) => [
            data[0] / 5, // Food ID (Normalized)
            data[1] / 140, // Number of Orders (Normalized)
            data[2] / 7 // Day of the Week (Normalized)
          ]);

          // Convert the filtered training data to TensorFlow tensors
          const filteredDataTensor = tf.tensor2d(normalizedFilteredData.map((data) => [data[0], data[2]])); // Use food ID and day of the week as input features
          const filteredLabelsTensor = tf.tensor2d(normalizedFilteredData.map((data) => [data[1]])); // Use number of orders as labels

          // Create the model
          const model = tf.sequential();
          model.add(tf.layers.dense({ units: 1, inputShape: [2] }));

          // Compile the model
          model.compile({ loss: 'meanSquaredError', optimizer: 'sgd' });

          // Train the model
          async function trainFilteredModel() {
            await model.fit(filteredDataTensor, filteredLabelsTensor, { epochs: 500 });
          }

          // Call the function to train the model with the filtered data
          await trainFilteredModel();

          // Store the trained model in the models array, associated with the food ID
          models[foodId - 1] = model;
        }

        // Function to handle predict button click
        function predictNextDayOrders() {
          const dayOfWeek = Number(document.getElementById('day-of-week-input').value);

          // Clear the previous table content before populating new predictions
          const tableBody = document.querySelector('#foodTable tbody');
          tableBody.innerHTML = '';

          // Loop through all food IDs (1 to 20) and make predictions
          for (let foodId = 1; foodId <= 20; foodId++) {
            const filteredData = originalData.filter(item => item[0] === foodId);

            if (filteredData.length > 0) {
              const foodIdNormalized = foodId / 5; // Normalize the input
              const dayOfWeekNormalized = dayOfWeek / 7; // Normalize the input

              // Prepare the input tensor for prediction
              const inputTensor = tf.tensor2d([[foodIdNormalized, dayOfWeekNormalized]]);

              // Make the prediction using the respective model for the food ID
              const normalizedPrediction = models[foodId - 1].predict(inputTensor).dataSync()[0];

              // Denormalize the prediction using the scaling factor for the number of orders
              const prediction = normalizedPrediction * 140; // Scaling factor for the number of orders

              // Create a new row in the table for each prediction
              const newRow = tableBody.insertRow();

              // Insert cells for Food ID and Prediction
              const foodIdCell = newRow.insertCell();
              const predictionCell = newRow.insertCell();

              // Set the content of the cells
              foodIdCell.textContent = foodId;
              predictionCell.textContent = prediction.toFixed(2);
            } else {
              alert('Food ID ' + foodId + ' not found in the data.');
            }
          }
        }

        // Function to handle train button click
        function trainModels() {
          // Train a separate model for each food ID (1 to 20)
          for (let foodId = 1; foodId <= 20; foodId++) {
            trainModelForFoodId(foodId);
          }
          alert('Models trained successfully for all food IDs.');
        }

        // Assign the predictNextDayOrders and trainModels functions to the corresponding button onclick events
        document.getElementById('predict-button').onclick = predictNextDayOrders;
        document.getElementById('train-button').onclick = trainModels;
      };

      reader.readAsText(file);
    }
  </script>
</head>

<body>
  <h1>Multiple Linear Regression</h1>
  <input type="file" accept=".csv" onchange="handleFileSelect(event)" />
  <div>
    <label for="day-of-week-input">Day of the Week:</label>
    <input type="number" id="day-of-week-input" step="1" min="1" max="7">
  </div>
  <button id="predict-button">Predict</button>
  <button id="train-button">Train Models</button>
  <div id="output-container">
    <table id="foodTable">
      <thead>
        <tr>
          <th>Food ID</th>
          <th>Prediction</th>
        </tr>
      </thead>
      <tbody>
        <!-- The table body will be populated with predictions dynamically -->
      </tbody>
    </table>
  </div>
</body>
</html>

