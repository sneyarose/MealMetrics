<!DOCTYPE html>
<html>
  <head>
    <title>Polynomial Regression</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script>
      function processCSV(csv) {
        const rows = csv.split('\n');
        const data = [];

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i].trim(); // Trim whitespace from the row
          if (row !== "") { // Skip empty rows
            const columns = row.split(',');
            const foodId = parseInt(columns[0]);
            const orders = parseInt(columns[3]);
            const date = new Date(columns[4]);
            const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();
            const item = [foodId, orders, dayOfWeek];
            data.push(item);
          }
        }

        return data;
      }

      async function handleFileSelect(event) {
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = async function (e) {
          const csv = e.target.result;
          const processedData = processCSV(csv);
          console.log(processedData); // Debugging: Check if the CSV data is processed correctly
          const formattedData = processedData.map(item => item.join(', ')).join('<br>');
          document.getElementById('display_data').innerHTML = "Processed";

          // Preprocess the training data (normalization)
          const normalizedTrainingData = processedData.map((data) => [
            data[0] / 5, // Food ID (Normalized)
            data[1] / 140, // Number of Orders (Normalized)
            data[2] / 7, // Day of the Week (Normalized)
            Math.pow(data[0] / 5, 2) // Food ID squared (Normalized)
          ]);

          // Convert the training data to TensorFlow tensors
          const trainingDataTensor = tf.tensor2d(normalizedTrainingData.map((data) => [data[0], data[2], data[3]])); // Use food ID, day of the week, and food ID squared as input features
          const trainingLabelsTensor = tf.tensor2d(normalizedTrainingData.map((data) => [data[1]])); // Use number of orders as labels
          console.log(trainingDataTensor.arraySync()); // Debugging: Check if the training data tensors are created correctly
          console.log(trainingLabelsTensor.arraySync()); // Debugging: Check if the training data tensors are created correctly

          // Create the polynomial regression model
          const model = tf.sequential();
          model.add(tf.layers.dense({ units: 1, inputShape: [3] }));

          // Compile the model
          model.compile({ loss: 'meanSquaredError', optimizer: 'sgd' });

          // Train the model
          async function trainModel() {
            await model.fit(trainingDataTensor, trainingLabelsTensor, { epochs: 500 });
          }

          await trainModel(); // Await the completion of model training

          // Predict the number of orders for the next day
          function predictNextDayOrders() {
            // Get the inputs from the user
            const foodId = Number(document.getElementById('food-id-input').value) / 5; // Normalize the input
            const dayOfWeek = Number(document.getElementById('day-of-week-input').value) / 7; // Normalize the input
            const foodIdSquared = Math.pow(foodId, 2) / 25; // Normalize the input

            // Prepare the input tensor for prediction
            const inputTensor = tf.tensor2d([[foodId, dayOfWeek, foodIdSquared]]);

            // Make the prediction
            const normalizedPrediction = model.predict(inputTensor).dataSync()[0];

            // Denormalize the prediction using the scaling factor for the number of orders
            const prediction = normalizedPrediction * 140; // Scaling factor for the number of orders

            // Display the prediction
            const outputContainer = document.getElementById('output-container');
            outputContainer.innerHTML = '<h3>Prediction for the Next Day:</h3>';
            outputContainer.innerHTML += '<p>Food ID: ' + foodId * 5 + '</p>';
            outputContainer.innerHTML += '<p>Prediction: Number of Orders for the Next Day: ' + prediction.toFixed(2) + '</p>';
          }

          // Assign the predictNextDayOrders function to the button onclick event
          document.getElementById('predict-button').onclick = predictNextDayOrders;
        };

        reader.readAsText(file);
      }
    </script>
  </head>

  <body>
    <h1>Polynomial Regression</h1>
    <input type="file" accept=".csv" onchange="handleFileSelect(event)" />
    <div id="display_data"></div>
    <div>
      <label for="food-id-input">Food ID:</label>
      <input type="number" id="food-id-input" step="1" min="1" max="20">
      <label for="day-of-week-input">Day of the Week:</label>
      <input type="number" id="day-of-week-input" step="1" min="1" max="7">
    </div>
    <button id="predict-button">Predict</button>
    <div id="output-container"></div>
  </body>
</html>